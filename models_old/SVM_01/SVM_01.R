# TODO

# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: xxxxxxxx, test_rmse: xxxxxxxx - xxx

# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 1.210156, test_rmse: 1.216561 - likes + dislikes(Baseline)
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 1.176357, test_rmse: 1.197309 - ↑comment_count
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 1.103021, test_rmse: 1.196318 - title_length
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 1.065675, test_rmse: 1.153623 - ↑tag_characters
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 1.065861, test_rmse: 1.155905 - flg_no_tags
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 1.005829, test_rmse: 1.160797 - tag_count
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 1.035493, test_rmse: 1.190762 - diff_likes_dislikes
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 1.058412, test_rmse: 1.161415 - sum_likes_dislikes
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 1.052116, test_rmse: 1.168883 - ratio_likes
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 1.042706, test_rmse: 1.174067 - ratio_comments_likedis
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 1.049863, test_rmse: 1.153829 - flg_no_description
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.9357648,test_rmse: 1.188921 - description_length
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 1.009315, test_rmse: 1.1576   - flg_url
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.9544836,test_rmse: 1.18521  - url_count
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.9497562,test_rmse: 1.070623 - ↑flg_japanese
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.949207, test_rmse: 1.091347 - flg_emoji
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.9191571,test_rmse: 1.104534 - flg_official
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.9426472,test_rmse: 1.085286 - flg_movie_number
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.9075,   test_rmse: 1.073787 - comments_disabled
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.9018677,test_rmse: 1.035728 - ↑ratings_disabled
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.7041617,test_rmse: 1.014963 - ↑published_year

# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.6994981,test_rmse: 1.031146 - min-max scaling

# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.5051841,test_rmse: 1.142956 - title_length + comments_disabled
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.6762122,test_rmse: 1.031384 - comments_disabled
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.6591805,test_rmse: 1.026364 - ↑flg_categoryId_low
# cost: 4.756828, rbf_sigma: 1.778279, margin: 0.1, train_rmse: 0.5407392,test_rmse: 1.014528 - ↑flg_categoryId_high

# cost: 4.287094, rbf_sigma: 1.412538,  margin: 0.1, train_rmse: 0.5838046, test_rmse: 0.9825075 - ↑
# cost: 2.828427, rbf_sigma: 0.2818383, margin: 0.1, train_rmse: 0.7780958, test_rmse: 0.8800588 - ↑
# cost: 2.828427, rbf_sigma: 0.05623413,margin: 0.1, train_rmse: 0.8546492, test_rmse: 0.8858918 - xxx
# cost: 2.828427, rbf_sigma: 0.07943282,margin: 0.1, train_rmse: 0.8416277, test_rmse: 0.8828667 - xxx
# cost: 2.732081, rbf_sigma: 0.08912509,margin: 0.1, train_rmse: 0.8376826, test_rmse: 0.8824144 - xxx
# cost: 2.685145, rbf_sigma: 0.08912509,margin: 0.1, train_rmse: 0.8379103, test_rmse: 0.8823818 - xxx
# cost: 2.593679, rbf_sigma: 0.09440609,margin: 0.1, train_rmse: 0.8361379, test_rmse: 0.8822944 - xxx
# cost: 2.505329, rbf_sigma: 0.09440609,margin: 0.1, train_rmse: 0.8366657, test_rmse: 0.8821250 - xxx
# cost: 2.419988, rbf_sigma: 0.09549926,margin: 0.1, train_rmse: 0.8367200, test_rmse: 0.8820545 - xxx
# cost: 2.337554, rbf_sigma: 0.09660509,margin: 0.1, train_rmse: 0.8367682, test_rmse: 0.8819848 - xxx
# cost: 2.257929, rbf_sigma: 0.09885531,margin: 0.1, train_rmse: 0.8363321, test_rmse: 0.8818691 - xxx
# cost: 2.106722, rbf_sigma: 0.10115795,margin: 0.1, train_rmse: 0.8364614, test_rmse: 0.8817697 - xxx
# cost: 2.034959, rbf_sigma: 0.1035142, margin: 0.1, train_rmse: 0.8360559, test_rmse: 0.8817179 - xxx
# cost: 2.034959, rbf_sigma: 0.1035142, margin: 0.1, train_rmse: xxxxxxxxx, test_rmse: xxxxxxxxx - xxx
# cost: 1.025,    rbf_sigma: 0.1122018, margin: 0.1, train_rmse: 0.8442825, test_rmse: 0.8815478 - xxx
# cost: 1.025,    rbf_sigma: 0.1122018, margin: 0.11428571, train_rmse: 0.8443143, test_rmse: 0.8811392 - xxx
# cost: 1.025,    rbf_sigma: 0.1122018, margin: 0.12714286, train_rmse: 0.8443216, test_rmse: 0.8810084 - xxx
# cost: 1.025,    rbf_sigma: 0.1122018, margin: xxxxxxxxxx, train_rmse: xxxxxxxxx, test_rmse: xxxxxxxxx - xxx
# cost: 1.025,    rbf_sigma: 0.1122018, margin: xxxxxxxxxx, train_rmse: xxxxxxxxx, test_rmse: xxxxxxxxx - xxx

library(tidyverse)
library(tidymodels)
library(furrr)

source("models/SVM_01/functions.R", encoding = "utf-8")

# Data Load ---------------------------------------------------------------

df.train_data <- load_train_data("data/01.input/train_data.csv") %>% clean() %>% dplyr::sample_frac(0.5)

df.cv <- create_cv(df.train_data)


# Feature Engineering -----------------------------------------------------

recipe <- create_recipe(df.train_data)
#recipes::prep(recipe) %>% recipes::juice() %>% summary()


# Model Definition --------------------------------------------------------

model <- parsnip::svm_rbf(
  mode = "regression",
  cost = parsnip::varying(),
  rbf_sigma = parsnip::varying(),
  margin = parsnip::varying()
) %>%
  parsnip::set_engine(engine = "kernlab")


# Hyper Parameter ---------------------------------------------------------

df.grid.params <- dials::grid_regular(
  dials::cost(range = c(0.03562391, 0.03562391)),
  dials::rbf_sigma(range = c(-0.95, -0.95)),
  dials::margin(range = c(0.12714286, 0.12714286)),
  levels = 1
)
df.grid.params


# Parametr Fitting --------------------------------------------------------

# 並列処理
future::plan(future::multisession(workers = 8))

system.time({
  set.seed(1025)

  df.results <-

    # ハイパーパラメータをモデルに適用
    purrr::pmap(df.grid.params, function(cost, rbf_sigma, margin) {
      parsnip::set_args(
        model,
        cost = cost,
        rbf_sigma = rbf_sigma,
        margin = margin
      )
    }) %>%

    # ハイパーパラメータの組み合わせごとにループ
    furrr::future_map_dfr(function(model.applied) {

      # クロスバリデーションの分割ごとにモデル構築&評価
      purrr::map_dfr(df.cv$splits, train_and_eval, recipe = recipe, model = model.applied) %>%

        # CV 分割全体の平均値を評価スコアとする
        dplyr::summarise_all(mean)
    }) %>%

    # 評価結果とパラメータを結合
    dplyr::bind_cols(df.grid.params) %>%

    # 評価スコアの順にソート(昇順)
    dplyr::arrange(
      test_rmse
    ) %>%
    
    dplyr::select(
      cost,
      rbf_sigma,
      margin,
      
      train_rmse,
      test_rmse
    )
})
df.results

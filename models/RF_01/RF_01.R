# TODO

# mtry: xx, trees: xxxx, min_n: xx, max.depth: xx, train_rmse: xxxxxxxx, test_rmse: xxxxxxxx - xxx

# mtry:  1, trees:  100, min_n:  2, train_rmse: 0.9741993, test_rmse: 1.112905 - xxx
# mtry:  4, trees:  200, min_n:  4, train_rmse: 0.3814111, test_rmse: 0.8520791- xxx
# mtry:  4, trees:  200, min_n:  4, train_rmse: 1.254263,  test_rmse: 1.259027 - max.depth = 3
# mtry:  4, trees:  200, min_n:  4, max.depth:  5, train_rmse: 1.016545,  test_rmse: 1.031093 - xxx
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8913728, test_rmse: 0.9296484 - Baseline
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8963982, test_rmse: 0.9355606 - channel_title_length
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8987418, test_rmse: 0.9371161 - flg_categoryId_low
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8913774, test_rmse: 0.9294975 - ↑flg_categoryId_high
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.9025248, test_rmse: 0.9394295 - flg_no_tags
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.901608,  test_rmse: 0.9398474 - tag_count
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.9029038, test_rmse: 0.9403092 - flg_no_description
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8998962, test_rmse: 0.9369556 - flg_url
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8993541, test_rmse: 0.9370783 - url_count
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8897887, test_rmse: 0.9288179 - ↑days_from_published
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8832499, test_rmse: 0.9224514 - ↑diff_likes_dislikes
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8823983, test_rmse: 0.9214767 - ↑sum_likes_dislikes
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8841226, test_rmse: 0.9247237 - ratio_likes
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8818021, test_rmse: 0.9215452 - sum_likes_dislikes_comments
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8853379, test_rmse: 0.9247567 - ratio_comments_likedis
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8715084, test_rmse: 0.9102648 - ↑flg_japanese
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8756907, test_rmse: 0.9141864 - flg_emoji
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8754178, test_rmse: 0.9137653 - ↑flg_official
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8830935, test_rmse: 0.9204637 - flg_movie_number
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8824653, test_rmse: 0.9204683 - published_hour2
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8886902, test_rmse: 0.9269602 - published_hour2_x + published_hour2_y
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8939229, test_rmse: 0.9329583 - published_month
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8988742, test_rmse: 0.936688  - published_month_x + published_month_y
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8940203, test_rmse: 0.9331812 - published_day
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8990487, test_rmse: 0.9370392 - published_day_x + published_day_y
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8942026, test_rmse: 0.9330791 - published_term_in_month
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.894163,  test_rmse: 0.9329589 - published_dow
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8991059, test_rmse: 0.9369826 - published_dow_x + published_dow_y
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8936581, test_rmse: 0.9330546 - published_hour
# mtry:  4, trees:  200, min_n:  4, max.depth:  7, train_rmse: 0.8989338, test_rmse: 0.9370585 - published_hour_x + published_hour_y

# mtry:  8, trees:  400, min_n:  4, max.depth:  7, train_rmse: 0.8436601, test_rmse: 0.8898011 - xxx
# mtry:  8, trees:  400, min_n:  3, max.depth:  7, train_rmse: 0.8435971, test_rmse: 0.8897913 - xxx
# mtry:  8, trees:  500, min_n:  3, max.depth:  7, train_rmse: 0.8437812, test_rmse: 0.8900985 - xxx

# Target Encoding
# train_rmse: 0.8302722, test_rmse: 0.8720791 - 最終結果

# mtry:  3, trees: 1000, min_n:  3, max.depth:  8, train_rmse: 0.7788753, test_rmse: 0.8502467 - xxx
# mtry: 11, trees: 1000, min_n:  3, max.depth:  8, train_rmse: 0.7740576, test_rmse: 0.8500278 - xxx
# mtry: 13, trees: 1000, min_n:  3, max.depth: 12, train_rmse: 0.5511495, test_rmse: 0.8170364 - xxx
# mtry: 13, trees: 1000, min_n:  3, max.depth: 14, train_rmse: 0.4580388, test_rmse: 0.8128413 - xxx
# mtry: 13, trees: 1000, min_n: 58, max.depth: 21, train_rmse: 0.6797194, test_rmse: 0.8284892 - xxx
# mtry: 13, trees: 1000, min_n: 58, max.depth: 29, train_rmse: 0.6794895, test_rmse: 0.8284707 - xxx
# mtry: 15, trees: 1000, min_n: 60, max.depth: 25, train_rmse: 0.6795816, test_rmse: 0.8286918 - xxx
# mtry: xx, trees: xxxx, min_n: xx, max.depth: xx, train_rmse: xxxxxxxxx, test_rmse: xxxxxxxxx - xxx

# 結論: 過学習させてでもカリカリにした方が良い
# mtry: 13, trees: 1000, min_n:  3, max.depth: 14, train_rmse: 0.4580388, test_rmse: 0.8128413 - xxx


library(tidyverse)
library(tidymodels)
library(furrr)

source("models/RF_01/functions.R", encoding = "utf-8")

# Data Load ---------------------------------------------------------------

df.train_data <- load_train_data("data/01.input/train_data.csv") %>% clean()

df.cv <- create_cv(df.train_data)


# Feature Engineering -----------------------------------------------------

recipe <- create_recipe(df.train_data)
#recipes::prep(recipe) %>% recipes::juice() %>% summary()


# Model Definition --------------------------------------------------------

model <- parsnip::rand_forest(
  mode = "regression",
  mtry  = parsnip::varying(),
  trees = parsnip::varying(),
  min_n = parsnip::varying()
) %>%
  parsnip::set_engine(
    engine = "ranger",
    num.threads = 1,
    seed = 1234
  )


# Hyper Parameter ---------------------------------------------------------

df.grid.params <- dials::grid_regular(
  dials::mtry(range = c(13, 13)),
  dials::trees(range = c(1000, 1000)),
  dials::min_n(range = c(3, 3)),
  levels = 1
) %>%
  tidyr::crossing(
    max.depth = 15:22
  )
df.grid.params


# Parametr Fitting --------------------------------------------------------

# 並列処理
future::plan(future::multisession(workers = 8))

system.time({
  set.seed(1025)

  df.results <-

    # ハイパーパラメータの組み合わせごとにループ
    furrr::future_pmap_dfr(df.grid.params, function(...) {

      # パラメータの適用
      model.applied <- parsnip::set_args(model, ...)

      # モデル構築用の説明変数を指定
      formula <- (
        y ~
          categoryId
        + likes
        + dislikes
        + comment_count
        + comments_disabled
        + ratings_disabled
        + title_length
        + published_year
        + flg_categoryId_high
        + tag_characters
        + description_length
        + days_from_published
        + diff_likes_dislikes
        + sum_likes_dislikes
        + flg_japanese
        + flg_official
        + categoryId_mean_y
        + categoryId_median_y
        + published_year_mean_y
        + flg_japanese_mean_y
        + flg_japanese_median_y
        + diff_categoryId_mean_comment_count
        + categoryId_max_comment_count
        + diff_comments_disabled_mean_dislikes
        + published_year_median_likes
        + ratio_published_year_median_likes
        + published_year_min_likes
        + published_year_sd_likes
        + diff_published_year_mean_dislikes
        + diff_flg_japanese_max_dislikes
        + diff_flg_japanese_max_comment_count
        + flg_japanese_sd_comment_count
      )

      # クロスバリデーションの分割ごとにモデル構築&評価
      purrr::map_dfr(df.cv$splits, train_and_eval, recipe = recipe, model = model.applied, formula = formula) %>%

        # CV 分割全体の平均値を評価スコアとする
        dplyr::summarise_all(mean)
    }) %>%

    # 評価結果とパラメータを結合
    dplyr::bind_cols(df.grid.params) %>%

    # 評価スコアの順にソート(昇順)
    dplyr::arrange(
      test_rmse
    ) %>%
    
    dplyr::select(
      colnames(df.grid.params),
      
      train_rmse,
      test_rmse
    )
})
df.results
